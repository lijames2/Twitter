<html>

<head>
    <title>Twitter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.css"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
        integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <link rel="icon" type="image/png" href="public/images/favicon.png">
    <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            populateTweets();
        });

        function redirect(options) {
            var $form = $("<form />");

            $form.attr("action", options.url);
            $form.attr("method", options.method);

            for (var data in options.data)
                $form.append('<input type="hidden" name="' + data + '" value="' + options.data[
                    data] + '" />');

            $("body").append($form);
            $form.submit();
        }

        function emptyList() {
            $('#tweetcolumn').empty();
        }

        function populateTweets() { //fix for reseting sockets
            fetch("/search", {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify()
                }).then(res => res.json())
                .then(data => {
                    console.log(data);
                    data.items.forEach(item => {
                        addTweet(item);
                    });
                }).catch(err => {
                    console.error('Error: ', err);
                });
        };

        function addTweet(tweet) {
            console.log(`adding ${tweet.id}`);
            var newTweet =
                `<div class="container"
                    <div class="tweet-header">
                        <strong>${tweet.username}</strong> <span style="color: #657786">@${tweet.username}</span> <span
                            class="tweet-time" style="color: #657786"> ${new Date(tweet.timestamp*1000)}</span>
                            <strong>ID : ${tweet.id}</strong>
                    </div>
                    <div class="tweet-content">
                        ${tweet.content}
                        </div>
                    <div class="tweet-footer">
                        <i class="fas fa-reply" style="padding-right: 10px;"> </i>0
                        <i class="fas fa-retweet" style="padding-left: 20px; padding-right: 10px;"> </i>${tweet.retweeted}
                        <i class="fa fa-heart" style="padding-left: 20px; padding-right: 10px;"> </i>${tweet.likes}
                    </div>
                    <br>
                '</div>`;
            $(newTweet).appendTo($('#tweetcolumn'));
        }

        function yeet() {
            let content = ($('#yeettext').val());
            var data = {
                content: content
            }
            fetch("/additem", {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }).then(res => res.json())
                .then(data => {
                    console.log(data);
                    emptyList();
                    populateTweets();
                    getItemToModal(data.id);
                }).catch(err => {
                    console.error('Error: ', err);
                });
        }

        function search() {
            emptyList();
            let timestamp = $('#time').val();
            let limit = $('#limit').val();
            var data = {
                timestamp: timestamp,
                limit: limit
            }
            fetch("/search", {
                    method: "POST",
                    headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }).then(res => res.json())
                .then(data => {
                    console.log(data);
                    data.items.forEach(item => {
                        addTweet(item);
                    });
                }).catch(err => {
                    console.error('Error: ', err);
                });
        }

        function getItemToModal(itemID) {
            fetch(`/item/${itemID}`, {
                    method: "GET"
                }).then(res => res.json())
                .then(data => {
                    console.log(data);
                    let item = data.item;
                    $('#modalUsername').text(item.username);
                    $('#modalHandle').text('@' + item.content);
                    $('#modalID').text('ID : ' + item.id);
                    $('#modalContent').text(item.content);
                    //$('#modalreplies').text(item.username);
                    $('#modalretweets').text(item.retweeted);
                    $('#modallikes').text(item.likes);
                    $('#itemModal').show();

                }).catch(err => {
                    console.error('Error: ', err);
                });
        }
    </script>
    <link rel="stylesheet" type="text/css" href="/css/twitter_html.css">
</head>

<body style="background: #e6ecf0;">
    <nav class="navbar twitter-nav" role="navigation" aria-label="main navigation">
        <div class="navbar-brand" style="border-bottom: 1px solid rgba(0,0,0,0.25);">
            <a class="navbar-item" href="/">
                <i class="fab fa-twitter fa-lg" style="color:#1da1f2; margin-left: 20px"></i>
            </a>
            <a role="button" class="navbar-burger burger" aria-label="menu" aria-expanded="false"
                data-target="navbarBasicExample">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>

        <div id="navbarBasicExample" class="navbar-menu" style="border-bottom: 1px solid rgba(0,0,0,0.25);">

            <div class="navbar-end">
                <div class="navbar-item">
                    <!--<form action="/search/" method="POST" style="margin-block-end: 0px">-->
                    <div class="field has-addons twitter-control">
                        <div class="control">
                            <input name="timestamp" id="time" class="input twitter-input" type="text"
                                placeholder="Input epoch time">
                        </div>
                        <div class="control">
                            <input name="limit" id="limit" class="input twitter-input" type="text"
                                placeholder="Input query limit">
                        </div>
                        <div class="control">
                            <!--<button type="submit" style="background: none; padding: 0px; border: none;">
                                    <i class="fas fa-search button twitter-icon"
                                        style="font-size: 12px; color: #14171a; padding-top: 7px"></i>
                                </button>-->
                            <input value="search" type="submit" id="searchBtn" onclick="search();">
                        </div>
                    </div>
                    <!--</form>-->
                </div>
                <div class="navbar-item">
                    <div>
                        <form action="/logout/" method="POST" style="margin-block-end: 0px">
                            <input type="submit" class="link-button" value="Sign Out" />
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div id="itemModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="getElementById('itemModal').style.display = 'none';">&times;</span>
            <div class="tweet-header">
                <strong id='modalUsername'></strong> <span style="color: #657786" id='modalHandle'></span> <span
                    class="tweet-time" style="color: #657786" id='modalTime'></span>
                    <strong id='modalID'></strong>
            </div>
            <div id='modalContent' class="tweet-content">
            </div>
            <div class="tweet-footer">
                <i class="fas fa-reply" style="padding-right: 10px;"> </i>
                <p id='modalreplies'>0</p>
                <i class="fas fa-retweet" style="padding-left: 20px; padding-right: 10px;"></i>
                <p id='modalretweets'>0</p>
                <i class="fa fa-heart" style="padding-left: 20px; padding-right: 10px;"></i>
                <p id='modallikes'>0</p>
            </div>
        </div>
    </div>


    <div class="container twitter-wrapper">
        <div class="tweet columns">
            <div class="column is-1 tweet-user">
                <i class="fas fa-user fa-2x" style="display: inline-block;
                        border-radius: 60px;
                        box-shadow: 0px 0px 2px rgb(25, 39, 52);
                        padding: 0.2em 0.3em;"></i>
            </div>
            <div id="tweetcolumn" class="column">
                <br>
            </div>
        </div>
        <div class="tweet tweet-compose">
            <!--<form action="/additem/" method="POST">-->
            <textarea id="yeettext" name="content" rows="5" class="tweet-textarea"
                placeholder="What's happening?"></textarea>
            <div class="control">
                <!--
                    <label class="radio">
                        <input type="radio" name="childType" value="retweet">
                        Reyeet
                        </label>
                        <label class="radio">
                            <input type="radio" name="childType" value="reply">
                            Reply
                        </label>
                        
                        <button type="submit" class="button is-right tweet-compose-btn">Share</button>
                        -->
                <input value="Yeet" type="submit" id="yeetBtn" class="button is-right tweet-compose-btn"
                    onclick="yeet();">
            </div>
            <!--</form>-->
        </div>
    </div>
</body>

</html>